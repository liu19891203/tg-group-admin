# é¡¹ç›®æ”¹è¿›å®æ–½æŠ¥å‘Š

## ä¸€ã€æ”¹è¿›æ¦‚è¿°

åŸºäºé¡¹ç›®æ£€æŸ¥ç»“æœï¼Œå·²å®Œæˆä»¥ä¸‹æ”¹è¿›ï¼š

### 1. é«˜ä¼˜å…ˆçº§é—®é¢˜ä¿®å¤

#### 1.1 æ•°æ®åº“ Schema è¯­æ³•é”™è¯¯ âœ…
**æ–‡ä»¶**: `database/schema.sql`
**ä¿®å¤å†…å®¹**: ä¿®æ­£ `points_config` å­—æ®µ JSON æ ¼å¼é”™è¯¯
```sql
-- ä¿®å¤å‰
points_config JSONB DEFAULT '{"enabled": true, "daily_limit": 100, 0.2 "per_message":, ...}'

-- ä¿®å¤å
points_config JSONB DEFAULT '{"enabled": true, "daily_limit": 100, "per_message": 0.2, ...}'
```

#### 1.2 JWT ç­¾åéªŒè¯å®Œå–„ âœ…
**æ–‡ä»¶**: `backend/middleware/auth.ts`
**ä¿®å¤å†…å®¹**: 
- æ·»åŠ  HMAC-SHA256 ç­¾åéªŒè¯
- ä½¿ç”¨ Node.js crypto æ¨¡å—å®ç°å®‰å…¨ç­¾å
- é˜²æ­¢ token ä¼ªé€ æ”»å‡»

```typescript
function createHmacSignature(data: string): string {
  return crypto
    .createHmac('sha256', JWT_SECRET)
    .update(data)
    .digest('base64')
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=/g, '');
}
```

#### 1.3 æ·»åŠ  axios ä¾èµ– âœ…
**æ–‡ä»¶**: `backend/package.json`
**ä¿®å¤å†…å®¹**: æ·»åŠ ç¼ºå¤±çš„ axios ä¾èµ–å£°æ˜

---

### 2. Telegram Bot äº¤äº’å¢å¼º

#### 2.1 ç§èŠæ¶ˆæ¯å¤„ç†å™¨ âœ…
**æ–°å»ºæ–‡ä»¶**: `backend/handlers/privateMessageHandler.ts`

**åŠŸèƒ½**:
- ç§èŠå‘½ä»¤å¤„ç† (/start, /help, /me, /settings, /groups, /rank)
- éªŒè¯ç ç§èŠå“åº”
- ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢
- ç¾¤ç»„åˆ—è¡¨å±•ç¤º

**é›†æˆ**: æ›´æ–° `webhook.ts` è·¯ç”±ï¼Œä¼˜å…ˆå¤„ç†ç§èŠæ¶ˆæ¯

#### 2.2 æŒä¹…èœå• (ReplyKeyboard) âœ…
**ä½ç½®**: `privateMessageHandler.ts`

**èœå•å¸ƒå±€**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“Š æˆ‘çš„ç§¯åˆ†  â”‚ ğŸ“‹ æˆ‘çš„ç¾¤ç»„  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ† æ’è¡Œæ¦œ   â”‚ â“ å¸®åŠ©     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        âš™ï¸ è®¾ç½®            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.3 Bot å‘½ä»¤èœå•è®¾ç½® âœ…
**æ–°å»ºæ–‡ä»¶**: `backend/api/admin/commands.ts`

**åŠŸèƒ½**:
- `setMyCommands` - è®¾ç½® Bot å‘½ä»¤èœå•
- `getMyCommands` - è·å–å½“å‰å‘½ä»¤
- `deleteMyCommands` - åˆ é™¤å‘½ä»¤
- æ”¯æŒä¸åŒä½œç”¨åŸŸ (ç§èŠ/ç¾¤ç»„/ç®¡ç†å‘˜)

**é»˜è®¤å‘½ä»¤é…ç½®**:

| ä½œç”¨åŸŸ | å‘½ä»¤ |
|--------|------|
| ç§èŠ | start, help, me, settings, groups, rank |
| ç¾¤ç»„ | checkin, me, rank, help |
| ç®¡ç†å‘˜ | config, stats, reload, admin |

#### 2.4 API æ‰©å±• âœ…
**æ–‡ä»¶**: `backend/lib/api.ts`

**æ–°å¢å‡½æ•°**:
- `setMyCommands()` - è®¾ç½®å‘½ä»¤èœå•
- `getMyCommands()` - è·å–å‘½ä»¤
- `deleteMyCommands()` - åˆ é™¤å‘½ä»¤
- `setChatMenuButton()` - è®¾ç½®èœå•æŒ‰é’®

---

### 3. å›è°ƒå¤„ç†å¢å¼º âœ…
**æ–‡ä»¶**: `backend/handlers/callbackHandler.ts`

**æ–°å¢å¤„ç†**:
- `settings_*` - è®¾ç½®å›è°ƒ
- `menu_*` - èœå•å¯¼èˆªå›è°ƒ

---

## äºŒã€æ–‡ä»¶å˜æ›´æ¸…å•

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `database/schema.sql` | ä¿®æ”¹ | ä¿®å¤ JSON è¯­æ³•é”™è¯¯ |
| `backend/package.json` | ä¿®æ”¹ | æ·»åŠ  axios ä¾èµ– |
| `backend/middleware/auth.ts` | ä¿®æ”¹ | JWT ç­¾åéªŒè¯ |
| `backend/lib/api.ts` | ä¿®æ”¹ | æ·»åŠ å‘½ä»¤èœå• API |
| `backend/api/telegram/webhook.ts` | ä¿®æ”¹ | ç§èŠè·¯ç”±å¤„ç† |
| `backend/handlers/privateMessageHandler.ts` | æ–°å»º | ç§èŠæ¶ˆæ¯å¤„ç†å™¨ |
| `backend/handlers/callbackHandler.ts` | ä¿®æ”¹ | èœå•å›è°ƒå¤„ç† |
| `backend/api/admin/commands.ts` | æ–°å»º | å‘½ä»¤èœå•ç®¡ç† |

---

## ä¸‰ã€æµ‹è¯•å»ºè®®

### 3.1 åŠŸèƒ½æµ‹è¯•
1. **ç§èŠæµ‹è¯•**
   - å‘é€ /start æŸ¥çœ‹æ¬¢è¿æ¶ˆæ¯
   - å‘é€ /help æŸ¥çœ‹å¸®åŠ©
   - å‘é€ /me æŸ¥çœ‹ä¸ªäººä¿¡æ¯
   - ç‚¹å‡»æŒä¹…èœå•æŒ‰é’®

2. **å‘½ä»¤èœå•æµ‹è¯•**
   - è°ƒç”¨ `/api/admin/commands/setup-all` è®¾ç½®å‘½ä»¤
   - åœ¨ Telegram å®¢æˆ·ç«¯æŸ¥çœ‹å‘½ä»¤èœå•

3. **JWT æµ‹è¯•**
   - ç™»å½•è·å– token
   - éªŒè¯ token ç­¾å
   - æµ‹è¯•è¿‡æœŸå¤„ç†

### 3.2 éƒ¨ç½²å‰æ£€æŸ¥
```bash
# å®‰è£…ä¾èµ–
cd backend && npm install

# ç±»å‹æ£€æŸ¥
npm run build

# è¿è¡Œæµ‹è¯•
npm test
```

---

## å››ã€åç»­æ”¹è¿›å»ºè®®

1. **æµ‹è¯•è¦†ç›–**: ä¸ºæ–°å¢åŠŸèƒ½ç¼–å†™å•å…ƒæµ‹è¯•
2. **æ–‡æ¡£å®Œå–„**: æ·»åŠ  API ä½¿ç”¨æ–‡æ¡£
3. **é”™è¯¯ç›‘æ§**: é›†æˆ Sentry ç­‰ç›‘æ§å·¥å…·
4. **æ—¥å¿—ç³»ç»Ÿ**: ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿— (Pino)

---

**æ”¹è¿›å®Œæˆæ—¶é—´**: 2026-02-12
**æ‰§è¡Œäºº**: AI Assistant (6A å·¥ä½œæµ)
