# ç”¨æˆ·-ç¾¤ç»„å…³è”ç®¡ç† Spec

## Why
å½“å‰æœºå™¨äººåœ¨ç§èŠçª—å£ä¸­æ— æ³•è¯†åˆ«ç”¨æˆ·èº«ä»½å’Œå…³è”çš„ç¾¤ç»„ã€‚ç”¨æˆ·å¸Œæœ›åœ¨ç§èŠä¸­é…ç½®æœºå™¨äººæ—¶ï¼Œç³»ç»Ÿåº”è¯¥ï¼š
1. è¯†åˆ«ç”¨æˆ·çš„ Telegram è´¦å·èº«ä»½
2. è¯†åˆ«è¯¥ç”¨æˆ·å°†æœºå™¨äººæ‹‰å…¥äº†å“ªäº›ç¾¤ç»„
3. å…è®¸ç”¨æˆ·å¯¹è¿™äº›ç¾¤ç»„è¿›è¡Œè®¾ç½®

## What Changes
- åœ¨ç§èŠä¸­è¯†åˆ«ç”¨æˆ·èº«ä»½ï¼ˆtelegram_idï¼‰
- å»ºç«‹ç”¨æˆ·ä¸ç¾¤ç»„çš„å…³è”å…³ç³»ï¼ˆè°æ‹‰æœºå™¨äººå…¥ç¾¤ï¼‰
- æŸ¥è¯¢ç”¨æˆ·å¯ç®¡ç†çš„ç¾¤ç»„åˆ—è¡¨
- åœ¨ç§èŠä¸­æä¾›ç¾¤ç»„é€‰æ‹©å’Œé…ç½®ç•Œé¢

## Impact
- Affected specs: ç”¨æˆ·èº«ä»½è¯†åˆ«ã€ç¾¤ç»„å…³è”ã€ç§èŠé…ç½®ç•Œé¢
- Affected code: `backend/api/telegram/webhook.ts`, æ–°å¢ç”¨æˆ·-ç¾¤ç»„å…³è”è¡¨

## ADDED Requirements

### Requirement: ç”¨æˆ·èº«ä»½è¯†åˆ«
The system SHALL identify the user in private chat:

#### Scenario: ç§èŠä¸­è¯†åˆ«ç”¨æˆ·
- **WHEN** ç”¨æˆ·åœ¨ç§èŠä¸­å‘é€å‘½ä»¤æˆ–ç‚¹å‡»æŒ‰é’®
- **THEN** ç³»ç»Ÿè·å–ç”¨æˆ·çš„ telegram_id
- **AND** ä»æ•°æ®åº“æŸ¥è¯¢è¯¥ç”¨æˆ·çš„ä¿¡æ¯

### Requirement: ç”¨æˆ·-ç¾¤ç»„å…³è”
The system SHALL track which user added the bot to groups:

#### Scenario: è®°å½•ç¾¤ç»„æ·»åŠ è€…
- **WHEN** æœºå™¨äººè¢«æ·»åŠ åˆ°ç¾¤ç»„æ—¶ï¼ˆmy_chat_member äº‹ä»¶ï¼‰
- **THEN** è®°å½•æ·»åŠ è€…çš„ telegram_id
- **AND** å»ºç«‹ user_group_relations è®°å½•

#### Scenario: æŸ¥è¯¢ç”¨æˆ·çš„ç¾¤ç»„
- **WHEN** ç”¨æˆ·åœ¨ç§èŠä¸­è¯·æ±‚æŸ¥çœ‹å¯ç®¡ç†çš„ç¾¤ç»„
- **THEN** ç³»ç»ŸæŸ¥è¯¢ user_group_relations è¡¨
- **AND** è¿”å›è¯¥ç”¨æˆ·æ·»åŠ æœºå™¨äººçš„æ‰€æœ‰ç¾¤ç»„åˆ—è¡¨

### Requirement: ç§èŠç¾¤ç»„é€‰æ‹©ç•Œé¢
The system SHALL provide a group selection interface in private chat:

#### Scenario: æ˜¾ç¤ºç¾¤ç»„åˆ—è¡¨
- **WHEN** ç”¨æˆ·åœ¨ç§èŠä¸­å‘é€ /mygroups æˆ–ç‚¹å‡»"æˆ‘çš„ç¾¤ç»„"æŒ‰é’®
- **THEN** æ˜¾ç¤ºè¯¥ç”¨æˆ·å¯ç®¡ç†çš„ç¾¤ç»„åˆ—è¡¨ï¼ˆå¸¦é€‰æ‹©æŒ‰é’®ï¼‰
- **AND** æ¯ä¸ªç¾¤ç»„æ˜¾ç¤ºåç§°å’Œæˆå‘˜æ•°

#### Scenario: é€‰æ‹©ç¾¤ç»„è¿›è¡Œé…ç½®
- **WHEN** ç”¨æˆ·ç‚¹å‡»æŸä¸ªç¾¤ç»„æŒ‰é’®
- **THEN** æ˜¾ç¤ºè¯¥ç¾¤ç»„çš„é…ç½®èœå•ï¼ˆä¸ç¾¤ç»„å†… /settings ç›¸åŒï¼‰
- **AND** æ‰€æœ‰ä¿®æ”¹åŒæ­¥åˆ°è¯¥ç¾¤ç»„

### Requirement: æƒé™éªŒè¯
The system SHALL verify user permissions:

#### Scenario: éªŒè¯ç¾¤ç»„ç®¡ç†å‘˜èº«ä»½
- **WHEN** ç”¨æˆ·å°è¯•é…ç½®æŸä¸ªç¾¤ç»„
- **THEN** éªŒè¯è¯¥ç”¨æˆ·æ˜¯å¦ä»ä¸ºè¯¥ç¾¤ç»„çš„ç®¡ç†å‘˜
- **AND** éç®¡ç†å‘˜æ˜¾ç¤º"æ— æƒé™"æç¤º

## Database Schema

### user_group_relations è¡¨
```sql
CREATE TABLE user_group_relations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_telegram_id BIGINT NOT NULL,
  group_id UUID REFERENCES groups(id),
  group_chat_id BIGINT NOT NULL,
  group_title TEXT,
  added_at TIMESTAMP DEFAULT NOW(),
  is_active BOOLEAN DEFAULT true,
  UNIQUE(user_telegram_id, group_chat_id)
);

CREATE INDEX idx_user_relations ON user_group_relations(user_telegram_id);
CREATE INDEX idx_group_relations ON user_group_relations(group_chat_id);
```

## UI Flow

```
ç§èŠä¸­å‘é€ /start æˆ– /mygroups
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ‘¤ æˆ‘çš„ç¾¤ç»„ç®¡ç†              â”‚
â”‚                             â”‚
â”‚ è¯·é€‰æ‹©è¦ç®¡ç†çš„ç¾¤ç»„ï¼š         â”‚
â”‚                             â”‚
â”‚ ğŸ“¢ ç¾¤ç»„A (128äºº)  [ç®¡ç†]    â”‚
â”‚ ğŸ“¢ ç¾¤ç»„B (56äºº)   [ç®¡ç†]    â”‚
â”‚ ğŸ“¢ ç¾¤ç»„C (234äºº)  [ç®¡ç†]    â”‚
â”‚                             â”‚
â”‚ [åˆ·æ–°åˆ—è¡¨]  [å¸®åŠ©]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“ ç‚¹å‡» [ç®¡ç†]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš™ï¸ ç¾¤ç»„A è®¾ç½®               â”‚
â”‚                             â”‚
â”‚ çŠ¶æ€ï¼š                       â”‚
â”‚ å…¥ç¾¤éªŒè¯ âœ…å·²å¼€å¯            â”‚
â”‚ æ¬¢è¿æ¶ˆæ¯ âœ…å·²å¼€å¯            â”‚
â”‚                             â”‚
â”‚ ğŸ˜Š è¿›ç¾¤éªŒè¯    â”‚ ğŸ‘‹ æ¬¢è¿æ¶ˆæ¯â”‚
â”‚ ...ï¼ˆä¸ç¾¤å†…èœå•ç›¸åŒï¼‰        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Technical Notes
- ä½¿ç”¨ `my_chat_member` äº‹ä»¶è·å–æ·»åŠ è€…ä¿¡æ¯
- ç§èŠä¸­ä½¿ç”¨ç›¸åŒçš„èœå•ç»“æ„å’Œ callback_data æ ¼å¼
- éœ€è¦é¢å¤–ä¼ é€’ group_chat_id å‚æ•°æ¥æ ‡è¯†ç›®æ ‡ç¾¤ç»„
