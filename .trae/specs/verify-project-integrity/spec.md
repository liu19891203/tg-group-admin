# 项目完整性验证与修复 - 产品需求文档

## 概述
- **摘要**: 验证 Telegram 群管机器人项目的功能完整性，确保所有前端配置功能在后端都有对应的实现逻辑
- **目的**: 用户反馈"很多设置没有实现"，需要系统性地检查并修复所有功能模块
- **目标用户**: 群组管理员

## 背景
项目包含 20 个前端功能模块，后端有 API 端点和 Webhook 处理器。经检查发现：
- 前端配置界面基本完整
- 后端 API 大多只是简单的数据库读写
- Webhook 中部分功能逻辑缺失或使用硬编码值
- 多个功能模块的配置没有被实际执行

## 功能模块状态分析

### ✅ 已实现功能
| 模块 | 前端 | 后端API | Webhook执行 | 状态 |
|------|------|---------|-------------|------|
| 机器人加入群组 | - | ✅ | ✅ | 正常 |
| 基础命令处理 | - | - | ⚠️ 硬编码 | 部分实现 |
| 入群验证 | ✅ | ✅ | ✅ | 已修复 |
| 广告过滤 | ✅ | ✅ | ⚠️ 硬编码关键词 | 需修复 |
| 自动回复 | ✅ | ✅ | ✅ | 正常 |

### ❌ 未实现/部分实现功能
| 模块 | 前端 | 后端API | Webhook执行 | 问题 |
|------|------|---------|-------------|------|
| 积分系统 | ✅ | ✅ | ⚠️ | 签到返回随机值，积分未真正累加 |
| 刷屏处理 | ✅ | ✅ | ❌ | 完全未实现检测逻辑 |
| 命令管理 | ✅ | ✅ | ❌ | 命令配置未生效，使用硬编码 |
| 定时消息 | ✅ | ✅ | ❌ | 无定时任务执行器 |
| 抽奖系统 | ✅ | ✅ | ❌ | 无开奖逻辑 |
| 聊天统计 | ✅ | ✅ | ⚠️ | 统计数据未正确收集 |
| 邀请统计 | ✅ | ✅ | ⚠️ | 邀请关系未正确追踪 |
| 欢迎消息 | ✅ | ✅ | ⚠️ | 未在入群时发送 |
| 自动删除 | ✅ | ✅ | ❌ | 未实现 |
| 自动封禁 | ✅ | ✅ | ❌ | 未实现 |
| 频道转发 | ✅ | ✅ | ❌ | 未实现 |
| 频道设置 | ✅ | ✅ | ❌ | 未实现 |
| 敏感词检测 | ✅ | ✅ | ❌ | 未实现 |
| 超级工具 | ✅ | ✅ | ❌ | 未实现 |
| 会员系统 | ✅ | ✅ | ❌ | 未实现 |

## 目标
1. 修复所有配置功能，确保前端设置能在后端正确执行
2. 替换所有硬编码值为数据库配置
3. 实现缺失的执行逻辑

## 非目标
- 不添加新功能
- 不修改前端界面
- 不修改数据库结构

## 功能需求

### FR-1: 积分系统完善
- **FR-1.1**: 签到功能应正确累加积分到用户账户
- **FR-1.2**: 消息积分应正确计算并累加
- **FR-1.3**: 积分排行榜应显示真实数据

### FR-2: 刷屏处理实现
- **FR-2.1**: 检测用户在时间窗口内的消息数量
- **FR-2.2**: 超过阈值时执行配置的惩罚措施
- **FR-2.3**: 检测重复消息

### FR-3: 命令管理生效
- **FR-3.1**: 从数据库读取命令配置
- **FR-3.2**: 根据配置启用/禁用命令
- **FR-3.3**: 自动删除命令消息

### FR-4: 广告过滤配置化
- **FR-4.1**: 从数据库读取广告关键词
- **FR-4.2**: 支持正则表达式匹配
- **FR-4.3**: 支持白名单用户

### FR-5: 定时消息执行
- **FR-5.1**: 创建定时任务调度器
- **FR-5.2**: 按配置时间发送消息
- **FR-5.3**: 支持周期性消息

### FR-6: 抽奖系统实现
- **FR-6.1**: 记录参与用户
- **FR-6.2**: 随机抽取中奖者
- **FR-6.3**: 发送中奖通知

### FR-7: 统计数据收集
- **FR-7.1**: 正确统计每日消息数
- **FR-7.2**: 正确统计活跃用户
- **FR-7.3**: 正确追踪邀请关系

### FR-8: 欢迎消息发送
- **FR-8.1**: 新成员入群时发送欢迎消息
- **FR-8.2**: 支持变量替换

## 验收标准

### AC-1: 积分系统
- **Given**: 用户发送消息或执行签到
- **When**: 消息被处理或签到命令执行
- **Then**: 积分正确累加到用户账户
- **Verification**: `programmatic`

### AC-2: 刷屏处理
- **Given**: 用户在短时间内发送大量消息
- **When**: 消息数量超过配置阈值
- **Then**: 执行配置的惩罚措施（删除/禁言/踢出）
- **Verification**: `programmatic`

### AC-3: 命令管理
- **Given**: 管理员在后台配置命令
- **When**: 用户发送命令
- **Then**: 根据配置响应或忽略
- **Verification**: `programmatic`

### AC-4: 广告过滤
- **Given**: 管理员配置广告关键词
- **When**: 消息包含关键词
- **Then**: 消息被删除并通知用户
- **Verification**: `programmatic`

### AC-5: 定时消息
- **Given**: 管理员创建定时消息
- **When**: 到达设定时间
- **Then**: 消息自动发送到群组
- **Verification**: `programmatic`

### AC-6: 抽奖系统
- **Given**: 管理员创建抽奖活动
- **When**: 用户参与并开奖
- **Then**: 中奖者被正确选出并通知
- **Verification**: `programmatic`

### AC-7: 统计数据
- **Given**: 群组有消息活动
- **When**: 每日统计任务执行
- **Then**: 数据正确记录到数据库
- **Verification**: `programmatic`

### AC-8: 欢迎消息
- **Given**: 管理员配置欢迎消息
- **When**: 新成员加入群组
- **Then**: 欢迎消息被发送
- **Verification**: `programmatic`

## 约束
- **技术**: 使用现有的技术栈（Node.js, Supabase, Telegram API）
- **部署**: Vercel Serverless 环境
- **兼容**: 不破坏现有功能

## 假设
- 数据库表结构已正确创建
- 机器人已获得必要的权限
- 用户配置已正确保存到数据库

## 开放问题
- [ ] 定时消息在 Serverless 环境如何实现？（可能需要外部定时服务）
- [ ] 抽奖参与方式是什么？（按钮点击？发送消息？）
- [ ] 统计任务的执行频率？
